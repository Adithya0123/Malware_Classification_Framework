import streamlit as st
import os
import subprocess

def save_uploaded_file(file):
    os.makedirs("temp", exist_ok=True)

    # Save the uploaded file to the temporary directory
    file_path = os.path.join("temp", file.name)
    with open(file_path, "wb") as f:
        f.write(file.getvalue())

    return file_path

def run_detection(file_path, detect_script_path):

    command = [
        "python",
        detect_script_path,
        "--weights", "best.pt",
        "--img", str(256),
        "--conf", str(0.1),
        "--source", file_path
    ]

    result = subprocess.run(command, capture_output=True, text=True)

    st.text(result.stdout)
    st.text(result.stderr)

    result1 = str(result)
    detected_malware = []

    # Check for each malware type in result1
    malware_types = {
        "Adialer.C": "Malware Adialer.C Detected",
        "Agent.FYI": "Malware Agent.FYI Detected",
        "Allaple.A": "Malware Allaple.A Detected",
        "Allaple.L": "Malware Allaple.L Detected",
        "Alueron.gen!J": "Malware Alueron.gen!J Detected",
        "Autorun.K": "Malware Autorun.K Detected",
        "C2LOP.gen!g": "Malware C2LOP.gen!g Detected",
        "C2LOP.P": "Malware C2LOP.P Detected",
        "Dialplatform.B": "Malware Dialplatform.B Detected",
        "Dontovo.A": "Malware Dontovo.A Detected",
        "Fakerean": "Malware Fakerean Detected",
        "Instantaccess": "Malware Instantaccess Detected",
        "Lolyda.AA1": "Malware Lolyda.AA1 Detected",
        "Lolyda.AA2": "Malware Lolyda.AA2 Detected",
        "Lolyda.AA3": "Malware Lolyda.AA3 Detected",
    }

    for key, value in malware_types.items():
        if key in result1:
            detected_malware.append(value)

    # Display all detected malware types
    if detected_malware:
        for malware in detected_malware:
            st.text(malware)
    else:
        st.text("Malware not detected")

# Inject custom CSS to set a background color and animations
css = """
<style>
/* Apply background color to the body */
body {
    background-color: #d5f4e6;  /* Replace with your desired color */
}

h1, h2, h3, h4, h5, h6, p {
    animation: fade-in 1s ease-in-out;
}

@keyframes fade-in {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}
</style>
"""

# Inject the CSS in the Streamlit app
st.markdown(css, unsafe_allow_html=True)

# Your Streamlit app content starts here
st.header('Malware Detection using YOLOv5')

file = st.file_uploader("Upload a file...", type=["jpg", "jpeg", "png", "mp4"])

if file is not None:
    st.write("Uploaded File:")
    if file.type.startswith('image'):
        st.image(file, caption='Uploaded Image')
        folder = 'temp_images'
    elif file.type.startswith('video'):
        st.video(file.read())
        folder = 'temp_videos'
    else:
        st.error("Unsupported file format.")
        st.stop()

    if st.button("Detect Malware"):
        file_path = save_uploaded_file(file)
        detect_script_path = "yolov5/detect.py"
        run_detection(file_path, detect_script_path)
